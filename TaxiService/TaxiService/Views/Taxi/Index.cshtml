@using TaxiService.Models.Base
<head>
    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/bootstrap")
    @Styles.Render("~/Content/css")
    @Scripts.Render("~/bundles/modernizr")
    <meta charset="utf-8" />
    <title>Taxi Service</title>
    <script src="~/Scripts/jquery-1.10.2.js"></script>
    <script type="text/javascript">
        $('document').ready(function () {
            $.get("/api/Default/getUser", function (data, status) {
                if (data.LoggedIn == false)
                {
                    alert("Please proceed to login");
                    var path = @Html.Raw(HttpUtility.JavaScriptStringEncode(Url.Content("~/"), true));
                    window.location.replace(path + "Home/Login");
                }
            });

            $('#logoff').click(function () {
                $.get("/api/Default/getUser", function (data, status) {
                    $.post("/api/Client/Logoff", data)
                    .done(function () {
                        var path = @Html.Raw(HttpUtility.JavaScriptStringEncode(Url.Content("~/"), true));
                        window.location.replace(path + "Home");
                    })
                    .fail(function () {
                        alert("Error occured")
                    });
                });
            });

            $('#profile').click(function () {
                $.get("/api/Default/getUser", function (data, status) {
                    var path = @Html.Raw(HttpUtility.JavaScriptStringEncode(Url.Content("~/"), true));
                    window.location.replace(path + "Taxi/U/"+data.Username);
                });
            });
            $('#updateRides').click(function () {
                $.get("/api/Client/getRides", function (data, status) {
                    let displayRides = "<div class=row>";
                    for (item in data)
                    {
                        displayRides += `<div style="border-style: groove"><div class="col-md-10" style="border-style: outset">RideID: ${data[item].ID}</div>`;
                        displayRides += `<table><tr><td>Status</td><td>Location</td><td>Destination</td><td>Price</td></tr>`;
                        displayRides += `<tr><td>${data[item].Status}</td><td>${data[item].Location.StreetName} ${data[item].Location.Place}</td><td>${data[item].Destination.StreetName} ${data[item].Destination.Place}</td><td>${data[item].Price}</td><div id=otkaziBtn${data[item].ID}></div></td></tr></table>`;
                        displayRides += `<div id=CommentSection${data[item].ID}></div></div>`;
                    }
                    displayRides += `</div`;
                    $('#taxiOrders').html(displayRides);
                    for (item in data)
                    {
                        let currentComment = `#CommentSection${data[item].ID}`;
                        let currentOption = `#otkaziBtn${data[item].ID}`;
                        let btnHtml = "";
                        if (data[item].Status == "Created" || data[item].Status == "Successful")
                        {
                            btnHtml += `<button id="CancelBtn" class="btn btn-default">Cancel</button>`;
                            $(currentOption).html(btnHtml);
                        }
                        else
                        {
                            btnHtml += `<button disabled="disabled" class="btn btn-default">Cancel</button>`;
                            $(currentOption).html(btnHtml);
                        }
                        $.get("/api/Client/getComment" + data[item].ID, function (commentData, status) {
                            let commentDiv = `<div style="border-style: inset"><div class="col-md-10>Comment</div"`;
                            commentDiv += `<div class="col-md-10"><table><caption>${commentData.ClientID.Username}</caption>`;
                            commentDiv += `<tr><td>Comment</td><td>${commentData.Summary}</td></tr>`;
                            commentDiv += `<tr><td>Stars: </td><td>${commentData.Starts}</td></tr></table>`;
                            commentDiv += `<p style="text-indent: 80%">${commentData.CommentDate}</p></div></div>`;
                            $(currentComment).html(commentDiv);
                        });
                    }
                });
            });
            $('#CancelBtn').click(function () {
                alert("Cancel");
            });
        });
    </script>
</head>
<div class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-header">
        <a href="~/Taxi/OrderRide" class="navbar-brand">Order Ride</a>
    </div>
    <div class="navbar-header navbar-right">
        <button class="navbar-brand" id="profile">My Profile</button>
        <button class="navbar-brand" id="logoff">Log Off</button>
    </div>
</div>

<div class="row">
    <div class="col-lg-10">
        <button class="btn btn-default btn-info" id="updateRides">Check your ride</button>
    </div>
    <div class="col-lg-10">
        <div id="taxiOrders"></div>
    </div>
</div>