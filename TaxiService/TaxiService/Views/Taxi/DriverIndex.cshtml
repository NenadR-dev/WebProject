
@{
    ViewBag.Title = "Index";
}
<head>
    <meta charset="utf-8" />
    <script src="~/Scripts/jquery-1.10.2.js"></script>
    <script type="text/javascript">
        function LoadRides() {
            $.get("/api/Dispacher/getNewRides", function (data, status) {
                let displayRides = "<div class=row>";
                for (item in data) {
                    displayRides += `<div style="border-style: groove"><div style="border-style: outset">RideID: <input disabled="disabled" id="RideID_${data[item].ID}" value ="${data[item].ID}"/></div>`;
                    displayRides += `<table><tr><td style="padding:0 15px 0 15px;">Status</td><td style="padding:0 15px 0 15px;">Location</td><td style="padding:0 15px 0 15px;">Destination</td><td style="padding:0 15px 0 15px;">Price</td></tr>`;
                    displayRides += `<tr><td style="padding:0 15px 0 15px;">${data[item].Status}</td>
                                         <td style="padding:0 15px 0 15px;">${data[item].Location.StreetName} ${data[item].Location.Place}</td>
                                         <td style="padding:0 15px 0 15px;">${data[item].Destination.StreetName} ${data[item].Destination.Place}</td>
                                         <td style="padding:0 15px 0 15px;">${data[item].Price}</td><td style="padding:0 15px 0 15px;"></td><td style="padding:0 15px 0 15px;"></tr></table>`;
                    displayRides += `<div id="CommentSection${data[item].ID}"></div><div id="AssignDiv${data[item].ID}"</div></div><br/><br/><br/><br/>`;
                }
                displayRides += `</div>`;
                $('#otherRidesDiv').html(displayRides);
                for (item in data) {
                    let currentComment = `#CommentSection${data[item].ID}`;
                    let currentAssign = `#AssignDiv${data[item].ID}`;
                    $.get("/api/Dispacher/getComment" + data[item].ID, function (commentData, status) {
                        if (commentData != undefined) {
                            let commentDiv = `<div style="border-style: inset;left: 30px"><div>Comment</div"`;
                            commentDiv += `<div><table><caption>${commentData.ClientID.Username}</caption>`;
                            commentDiv += `<tr><td>Comment</td><td><textarea readonly="readonly">${commentData.Summary}</textarea></td></tr>`;
                            commentDiv += `<tr><td>Stars: </td><td>${commentData.Starts}</td></tr></table>`;
                            commentDiv += `<p style="text-indent: 80%">${commentData.CommentDate}</p></div></div>`;
                            $(currentComment).html(commentDiv);
                        }
                    });
                    if (data[item].Status == "Created") {
                        btnHtml += `<button id="AcceptBtn" name="${data[item].ID}" class="btn btn-default">Accept</button>`;
                        $(currentAssign).html(btnHtml);
                    }

                }
            });

            $.get("/api/Dispacher/getDriverRides", function (data, status) {
                let displayRides = "<div class=row>";
                for (item in data) {
                    displayRides += `<div style="border-style: groove"><div style="border-style: outset">RideID: <input disabled="disabled" id="RideID_${data[item].ID}" value ="${data[item].ID}"/></div>`;
                    displayRides += `<table><tr><td style="padding:0 15px 0 15px;">Status</td>
                                     <td style="padding:0 15px 0 15px;">Location</td>
                                     <td style="padding:0 15px 0 15px;">Destination</td>
                                     <td style="padding:0 15px 0 15px;">Price</td></tr>`;
                    displayRides += `<tr><td style="padding:0 15px 0 15px;">${data[item].Status}</td>
                                         <td style="padding:0 15px 0 15px;">${data[item].Location.StreetName} ${data[item].Location.Place}</td>
                                         <td style="padding:0 15px 0 15px;">${data[item].Destination.StreetName} ${data[item].Destination.Place}</td>
                                         <td style="padding:0 15px 0 15px;">${data[item].Price}</td><td style="padding:0 15px 0 15px;"></td></tr></table>`;
                    displayRides += `<div id="CommentSection${data[item].ID}"></div>
                                     <div id="AcceptDiv${data[item].ID}"</div></div>`;
                }
                displayRides += `</div></div><br/><br/>`;
                $('#dispacherRidesDiv').html(displayRides);
                for (item in data) {
                    let currentComment = `#CommentSection${data[item].ID}`;
                    let currentAccept = `#AcceptDiv${data[item].ID}`;
                    let btnHtml = "";
                    $.get("/api/Dispacher/getComment" + data[item].ID, function (commentData, status) {
                        if (commentData != undefined) {
                            let commentDiv = `<div style="border-style: inset;left: 30px"><div>Comment</div"`;
                            commentDiv += `<div><table><caption>${commentData.ClientID.Username}</caption>`;
                            commentDiv += `<tr><td>Comment</td><td><textarea readonly="readonly">${commentData.Summary}</textarea></td></tr>`;
                            commentDiv += `<tr><td>Stars: </td><td>${commentData.Starts}</td></tr></table>`;
                            commentDiv += `<p style="text-indent: 80%">${commentData.CommentDate}</p></div></div>`;
                            $(currentComment).html(commentDiv);
                        }
                    });
                    if(data[item].Status == "Accepted") {
                        btnHtml += `<div><button id="CompleteRideBtn" name="${data[item].ID}" class="btn btn-default">Complete Ride</button>
                                    <button id="CancelBtn" name="${data[item].ID}" class="btn btn-default">Cancel</button></div>`;
                        $(currentAssign).html(btnHtml);
                    }
                }
            });
        }

        $(document).on('click', '#AcceptBtn', function () {
            let rideID = $(this).attr('name');
            $.post("/api/Driver/AcceptRide" + rideID, function (data, status) {
                LoadRides();
            });
        });
        $(document).on('click', '#CompleteRideBtn', function () {
            let rideID = $(this).attr('name');
            $.post("/api/Driver/CompleteRide" + rideID, )
                .done(function () {
                    LoadRides();
                });
        });
        $(document).on('click', '#CommentID', function () {
            let commentID = $(this).attr('name');
            let commentData = {
                Summary: $('#Com_' + commentID).val(),
                Stars: $('#starField' + commentID).val(),
                ID: commentID
            }
            $.post("/api/Driver/addComment", data)
                .done(function () {
                    LoadRides();
                })
                .fail(function () {
                    alert("Error at adding comment");
                });
        });

        $(document).on('click', '#CancelBtn', function () {
            let CommentForm = `<div style="border-style: inset;left: 30px"><div>Comment</div>`;
            let CommentID = $(this).attr('name');
            CommentForm += `<div><textarea cols="40" rows="5" type="text" id="Com_${CommentID}" name="CommentText"></textarea></div>`;
            CommentForm += `<div><input type="submit" name="${CommentID}" id="CommentID"/><label>Stars:</label> <input id="starField${CommentID}" type="number" required="required" min="1" maxlength="1" max="5" range="1"</div></div>`;
            $('#CommentSection' + CommentID).html(CommentForm);
            $.post("/api/Driver/CancelRide" + CommentID);
        });

    </script>
</head>

<div class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-header">
        <a href="~/Taxi/OrderRide" class="navbar-brand">Order Ride</a>
        <a href="~/Taxi/AddDriver" class="navbar-brand">Add Driver</a>
        <a href="~/Taxi/ManageClients" class="navbar-brand">Manage Clients</a>
        <button class="navbar-brand" type="submit" id="updateRides" style="background-color:transparent; border:none">Show Rides</button>
    </div>
    <div class="navbar-header navbar-right">
        <button class="navbar-brand" id="profile" style="background-color:transparent">My Profile</button>
        <button class="navbar-brand" id="logoff" style="background-color:transparent">Log Off</button>
    </div>
</div>

<div id="container" style="width:100%;">
    <div id="dispacherRidesDiv" style="float:left; width:50%;" class="col-md-5 col-sm-pull-1"></div>
    <div id="otherRidesDiv" style="float:right; width:50%;" class="col-md-5 col-sm-push-1"></div>
</div>

